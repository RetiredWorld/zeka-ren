---
date: 2021-08-27
title: 记树莓派奇怪的 “定时断网”
tags:
  - Linux
---
树莓派莫名奇妙断网，而且时间非常有周期性，为 12h。

这与 DHCP 租约时间很符合，因此猜测是否是 DHCP 客户端出现了问题。但是对树莓派网络软件不够了解，于是在论坛上面找到了 [这个帖子](https://www.raspberrypi.org/forums/viewtopic.php?t=308463) 解决了问题。

树莓派轻量包默认没带 NetworkManager，而是使用 `dhcpc` 作为 dhcp 的客户端，
使用 `systemctl status dhcpcd` 查看 `dhcpcd` 的状态，果然发现它挂了。于是在 12h 后 dhcp 租约过期，自然而然挂了。

github 上有 [相关 issue](https://github.com/raspberrypi/linux/issues/4092)，说明原因为树莓派上跑的容器太多，而每个容器都要分配网络，导致 `dhcpcd` 承受不住挂掉。

最简单的修改方法为在 `/etc/dhcpcd.conf` 文件下加上 `denyinterfaces veth*` 这一行，然后重启 dhcpd 服务。

上面的修改会拒绝所有 docker 虚拟出的接口对 dhcp 客户端的访问。所以理论上说对所有容器来说，它的访问是 denied 的，因此理论上也会发生 12h 后宕机的问题。但是 docker 容器的 dhcp 租约为 forever，意味着不会过期，因此没有这个问题。

那么上面的修改是否会对容器的产生与销毁产生影响呢？经过测试似乎不会，也就是 docker 可以不需要通过 `dhcpcd` 来实现容器的网络。

> 容器在使用 docker 模型的时候分配 ip 是否需要通过 dhcp 客户端？似乎是不必要，因为 dhcp 只是获取 ip 的一种方式。因此猜测 docker 的模型是在 dhcp 不可用的时候直接对容器分配 ip。这可以解释为什么在拒绝虚拟网口的访问后不会影响容器的正常功能。

